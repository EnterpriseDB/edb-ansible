name: edb-ansible testing

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Execute ansible-lint
    steps:
      - uses: actions/checkout@v2
      - run: |
          docker run --rm -v $(pwd):/data cytopia/ansible-lint playbook.yml
  setup-repo:
    runs-on: ubuntu-latest
    name: Execute setup_repo tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_repo rocky8
  install-dbserver:
    runs-on: ubuntu-latest
    name: Execute install_dbserver tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/install_dbserver rocky8
  initdb-dbserver:
    runs-on: ubuntu-latest
    name: Execute init_dbserver tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/init_dbserver rocky8
  setup-replication:
    runs-on: ubuntu-latest
    name: Execute setup_replication tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_replication rocky8
  manage-dbserver:
    runs-on: ubuntu-latest
    name: Execute manage_dbserver tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/manage_dbserver rocky8
  setup-pgpool2:
    runs-on: ubuntu-latest
    name: Execute setup_pgpool2 tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_pgpool2 rocky8
  manage-pgpool2:
    runs-on: ubuntu-latest
    name: Execute manage_pgpool2 tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/manage_pgpool2 rocky8
  setup-pgbouncer:
    runs-on: ubuntu-latest
    name: Execute setup_pgbouncer tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_pgbouncer rocky8
  manage-pgbouncer:
    runs-on: ubuntu-latest
    name: Execute manage_pgbouncer tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/manage_pgbouncer rocky8
  setup-repmgr:
    runs-on: ubuntu-latest
    name: Execute setup_repmgr tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_repmgr rocky8
  setup-hammerdbserver:
    runs-on: ubuntu-latest
    name: Execute setup_hammerdbserver tests for PostgreSQL 14 on RockyLinux8
    steps:
      - uses: actions/checkout@v2
      - run: sudo apt install ansible -y
      - run: make
      - run: EDB_PG_TYPE=PG EDB_PG_VERSION=14 EDB_ENABLE_REPO=false make -C tests/cases/setup_hammerdbserver rocky8