---
- name: Disable builtin postgresql module
  shell: >
    dnf -qy module disable postgresql
  args:
    executable: /bin/bash
  register: disable_builtin_postgres
  changed_when: disable_builtin_postgres.rc == 0
  failed_when: disable_builtin_postgres.rc != 0
  ignore_errors: yes
  become: true
  when: ansible_distribution_major_version == '8'

- name: Install require python package on EL7
  package:
    name:
      - python-pycurl
      - libselinux-python
      - python-ipaddress
    state: present
  when: ansible_distribution_major_version == '7'
  become: true

- name: Install require python package on EL8
  package:
    name:
      - python3-pycurl
      - python3-libselinux
    state: present
  become: true
  when: ansible_distribution_major_version == '8'

- name: Install require python package up to PG v14
  package:
    name:
      - python3
      - python3-libs
    state: present
  become: true
  when: pg_version|int >= 14


- name: Install Postgres
  package:
    name:
      - libxslt
      - libicu
      - glibc-common
      - postgresql{{ pg_version }}-libs
      - postgresql{{ pg_version }}
      - postgresql{{ pg_version }}-server
      - postgresql{{ pg_version }}-contrib
    state: present
  become: true
  when: rpm_install==false

- name: Install Postgres rpm list
  ansible.builtin.yum:
    name: "{{ item.name }}"
    state: present
  become: true
  loop: "{{ rpm_list }}"
  when:
    - rpm_install
    - pg_minor_version is defined
    - rpm_list|length > 0

- name: Install psycopg2 on EL7
  package:
    name:
      - python-psycopg2
    state: present
  when: ansible_distribution_major_version == '7'
  become: true

- name: Install psycopg2 on EL8
  package:
    name:
      - python3-psycopg2
    state: present
  when: ansible_distribution_major_version == '8'
  become: true