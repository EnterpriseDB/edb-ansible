---
- name: Gather service facts
  ansible.builtin.service_facts:

- name: Set fact pg_service for RedHat
  set_fact:
    pg_service: "postgresql-{{ pg_version }}.service"
  when: ansible_os_family == 'RedHat'

- name: Stop pg service if running
  ansible.builtin.systemd:
    name: "{{ pg_service }}"
    state: stopped
    enabled: false
  when:
    - ansible_facts.services[pg_service] is defined
    - ansible_facts.services[pg_service].state == 'running'
  become: yes

- name: Remove require python package on EL7
  package:
    name:
      - python2-psycopg2
    state: absent
  when: ansible_distribution_major_version == '7'
  become: true

- name: Remove require python package on EL8
  package:
    name:
      - python3-psycopg2
    state: absent
  become: true
  when: ansible_distribution_major_version == '8'

- name: Remove Postgres
  package:
    name:
      - postgresql{{ pg_version }}-libs
      - postgresql{{ pg_version }}
      - postgresql{{ pg_version }}-server
      - postgresql{{ pg_version }}-contrib
    state: absent
  become: true

- name: Remove sslutils
  ansible.builtin.package:
    name:
      - sslutils_{{ pg_version }}
    state: absent
    update_cache: true
  become: true
  when: pg_ssl