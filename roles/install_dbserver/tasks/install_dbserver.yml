---
- name : Check Operating System,  PostgreSQL type, PostgreSQL version
  include_role:
    name: common
    tasks_from: check_version.yml

- name: Gather service facts
  ansible.builtin.service_facts:

- name: Set fact pg_service for RedHat
  set_fact:
    pg_service: "postgresql-{{ pg_version }}"
  when: ansible_os_family == 'RedHat'

- name: Set fact pg_service for Debian
  set_fact:
    pg_service: "postgresql@{{ pg_version }}-main"
  when: ansible_os_family == 'Debian'

- name: Stop pg service if running
  systemd:
    name: "{{ pg_service }}"
    state: stopped
    enabled: false
  when:
    - ansible_facts.services[pg_service] is defined
    - ansible_facts.services[pg_service].state == 'running'
  become: yes

- name: Remove Postgres packages
#  debugger: always
  include_tasks: "{{ pg_type }}_{{ ansible_os_family }}_rm_install.yml"
  when:
    - force_install is defined
    - force_install

- name: Install and Configure Postgres
  include_tasks: "{{ pg_type }}_{{ ansible_os_family }}_install.yml"

- name: Enable coredump based on enable_core_dump
  include_tasks: linux_coredump.yml
  when: enable_core_dump|bool
