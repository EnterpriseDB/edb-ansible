---
# ref: https://access.redhat.com/documentation/ko-kr/red_hat_enterprise_linux/6/html/resource_management_guide/sec-memory
- name: Ensure memory limit
  ansible.builtin.shell: |
    if [ `cat /sys/fs/cgroup/memory/memory.limit_in_bytes` != $((0x7FFFFFFFFFFFF000)) ]; then 
      echo -n $((`cat /sys/fs/cgroup/memory/memory.limit_in_bytes`/1024/1024))
    fi
  register: _cgroup_memory_limit
  become: true

- name: Set Total memory in container
  ansible.builtin.set_fact:
    sys_memtotal_mb: "{{ _cgroup_memory_limit.stdout | int }}"
  when: _cgroup_memory_limit.stdout_lines | length > 0
  become: true

# base: "cpu cores" of /proc/cpuinfo
- name: Set core siblings
  ansible.builtin.shell: |
    set -o pipefail && cat /proc/cpuinfo | grep "processor" | wc -l
  become: true
  register: _siblings_core

# ansible_processor_nproc is number of vcpus available to the scheduler
# https://docs.ansible.com/ansible/latest/porting_guides/porting_guide_2.10.html
- name: Set the variable sys_nvcpus by cpu_set ratio
  set_fact:
    sys_nvcpus: "{{ [sys_nvcpus | int * ( ansible_processor_nproc | int / _siblings_core.stdout | int ), 1] | max }}"

# https://kernel.googlesource.com/pub/scm/linux/kernel/git/glommer/memcg/+/cpu_stat/Documentation/cgroups/cpu.txt
# docker's --cpus option is made by changing cpu.cfs_quota_us
# The cpu period assumes little change at 100000 microseconds.

- name: Check CFS quota
  ansible.builtin.command: >
    cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
  become: true
  register: _cfs_quota

- name: Set the variable sys_nvcpus by CFS ratio
  block:
    - name: Check CFS period
      ansible.builtin.command: >
        cat /sys/fs/cgroup/cpu/cpu.cfs_period_us
      become: true
      register: _cfs_period
    - name: Set the variable sys_nvcpus by CFS scheduler ratio
      ansible.builtin.set_fact:
        sys_nvcpus: "{{ [( sys_nvcpus | float * _cfs_quota.stdout | float / _cfs_period.stdout | float ) | int, 1] | max }}"
  when: _cfs_quota.stdout != "-1"

# TODO : If ansible machine is local, It is needed caculate groups share weights
