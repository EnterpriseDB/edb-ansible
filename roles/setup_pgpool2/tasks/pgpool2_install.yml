---
- name: Disable builtin postgresql module on EL8
  shell: >
    dnf -qy module disable postgresql
  args:
    executable: /bin/bash
  register: disable_builtin_postgres
  changed_when: disable_builtin_postgres.rc == 0
  failed_when: disable_builtin_postgres.rc != 0
  ignore_errors: true
  become: true
  when:
    - ansible_distribution_major_version == '8'
    - ansible_os_family == 'RedHat'

- name: Install pgpoolII package on RedHat
  ansible.builtin.set_fact:
    pgpool2_package_name: "https://www.pgpool.net/yum/rpms/4.3/redhat/rhel-\
      {{ ansible_distribution_major_version }}-{{ ansible_architecture }}/\
      pgpool-II-pg14-4.3.3-1pgdg.rhel{{ ansible_distribution_major_version }}.{{ ansible_architecture }}.rpm"
    state: present
  when:
    - ansible_os_family == 'RedHat'
    - pgpool2_version == 4.3

- name: Install pgpoolII requried package on RedHat
  ansible.builtin.package:
    name:
      - "libevent"
      - "libmemcached"
      - "{{ pgpool2_package_name }}"
    state: present
  when:
    - ansible_os_family == 'RedHat'
  become: true

- name: Install openssl package on RedHat
  ansible.builtin.package:
    name: "openssl"
    state: present
  when:
    - ansible_os_family == 'RedHat'
    - pgpool2_ssl
  become: true
