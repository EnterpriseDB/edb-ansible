---
- name: Re-gather facts as non-root ansible user
  ansible.builtin.gather_facts:
  become: false

- name: Download HammerDB
  ansible.builtin.get_url:
    url: "{{ hammerdb_url }}/v{{ hammerdb_version }}/{{ hammerdb_filename }}"
    dest: "{{ ansible_user_dir }}/{{ hammerdb_filename }}"
    mode: '0644'

- name: Install HammerDB
  ansible.builtin.unarchive:
    src: "{{ ansible_user_dir }}/{{ hammerdb_filename }}"
    dest: "{{ ansible_user_dir }}"
    remote_src: true

# We need this Azure Database hack until this is resolved:
# https://github.com/TPC-Council/HammerDB/issues/163

- name: Create HammerDB patch for Azure Database
  ansible.builtin.template:
    dest: hammerdb-{{ hammerdb_version }}-azure-db.patch
    src: hammerdb-{{ hammerdb_version }}-azure-db.patch.template
    mode: 0644
  become: false
  when: azure_db_hackery is defined and azure_db_hackery

- name: Apply HammerDB patch
  ansible.posix.patch:
    remote_src: true
    src: hammerdb-{{ hammerdb_version }}-azure-db.patch
    basedir: HammerDB-{{ hammerdb_version }}
    strip: 1
  when: azure_db_hackery is defined and azure_db_hackery
