#!/bin/bash -eu

export PGPOOL_PATH="{{ pgpool2_bin_path }}"
export PCP_USER="{{ pcp_admin_user }}"
export PCP_PORT={{ pgpool2_pcp_port }}

declare -a POOLERS=(
{% for item in pgpool2_nodes %}
	"{{ item }}"
{% endfor %}
)

pcp_control={{ efm_bin_path }}/pcp_control.sh
node=$1
role=$2

for i in "${POOLERS[@]}"
do
	export PCP_HOST=$i
	echo "Attaching node $node on ${PCP_HOST}"
	$pcp_control attach $node
	if [ "$role" = "p" ]; then
		$pcp_control promote $node
	fi
done
