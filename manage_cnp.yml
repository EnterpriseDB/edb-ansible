# Original work Copyright 2019-2020, EnterpriseDB Corporation
#
# Installs Roles and Collections requirements
# ansible-galaxy install --force -r requirements.yml
#
# pip install openshift pyyaml kubernetes
# pip install pyhelm
---
- name: Manage a CloudNativePG or CloudNative Postgres Cluster Playbook
  hosts: localhost
  gather_facts: false

  collections:
    - edb_devops.edb_postgres

  pre_tasks:
    - name: Initialize the user defined variables
      ansible.builtin.set_fact:
        # Options"
        # add-db, add-schema, add-role
        # drop-db, drop-schema, drop-role
        # execute-sql-script
        # apply-manifest, remove-manifest
        # configure-memory, configure-pg-hba
        cnp_task: 
        - drop-schema
        - drop-role
        - drop-schema
        - add-db
        # CloudNativePG Namespace
        cnpg_namespace: default
        # CloudNativePG Cluster Name
        cluster_name: cluster-example
        # CloudNativePG Pod Name
        pod_name: cluster-example-1
        # Databases
        db_name: edb
        # Schemas
        schema_name: edb_schema
        # Roles
        db_role: edb_role
        db_role_password: admin
        # SQL Script
        sql_script: DROP DATABASE {{ db_name }};
        # Manifest Filename
        manifest_filename: configure_memory.yml
        # Scale Replicas Number
        scale_replicas_to: 3
        # Scale Manifest Filename
        scale_manifest_filename: roles/manage_cnp/files/cluster-example.yml

  roles:
    - role: manage_cnp
      when: cnp_task is defined
