---
- hosts: all
  name: Postgres deployment playbook
  become: yes
  gather_facts: yes

  collections:
    - edb_devops.edb_postgres

  pre_tasks:
    - name: Initialize the user defined variables
      set_fact:
        disable_logging: false

        pg_postgres_conf_params:
          - name: shared_buffers
            value: "256MB"

        pg_databases:
          - name: testdb
            owner: enterprisedb
            encoding: UTF-8

        pg_hba_ip_addresses:
          - contype: "host"
            users: "all"
            databases: "postgres"
            method: "trust"
            source: "192.168.56.128"
            state: present

        pg_slots:
          - name: "test_slot"
            slot_type: "physical"
            state: present

        pg_extensions:
          - name: "hstore"
            database: postgres
            state: present
        
        pg_grant_roles:
          - role: pg_monitor
            user: enterprisedb

        # pg_copy_files:
        #  - file: ./create-table.sql
        #    remote_file: /tmp/create-table.sql
        #    owner: enterprisedb
        #    group: enterprisedb
        #    mode: '0644'


        # pg_sql_scripts:
        #   - file_path: "/tmp/create-table.sql"
        #     db: testdb

        pg_query:
          - query: "CREATE TABLE IF NOT EXISTS test2()"
            db: postgres

        pg_pgpass_values:
          - host: "127.0.0.1"
            database: postgres
            user: my_user
            password: 1234
            state: present
            create: true

  roles:
    - role: setup_repo
      when: "'setup_repo' in lookup('edb_devops.edb_postgres.supported_roles', wantlist=True)"
    - role: install_dbserver
      when: "'install_dbserver' in lookup('edb_devops.edb_postgres.supported_roles', wantlist=True)"
    - role: init_dbserver
      when: "'init_dbserver' in lookup('edb_devops.edb_postgres.supported_roles', wantlist=True)"
    - role: manage_dbserver
      when: "'manage_dbserver' in lookup('edb_devops.edb_postgres.supported_roles', wantlist=True)"
